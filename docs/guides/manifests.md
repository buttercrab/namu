# Manifests

NAMU supports two sources of truth:
- `namu.toml` for project-level configuration (preferred).
- JSON manifests inside task artifacts and workflow bundles (generated by the CLI).

## Project config (`namu.toml`)
`namu build` will read `namu.toml` when present and generate the task and workflow bundles under `dist/`.

Example:
```toml
[project]
name = "my-pipeline"
workflows_crate = "examples/advanced/workflows"
registry = "namu"

[registry.namu]
index = "https://registry.namu.dev/index"

[tasks.add]
crate = "namu-task-add"
version = "0.1.0"
path = "examples/advanced/tasks/add"
kind = "single"
runtime = "native"
trust = "trusted"
resource_class = "cpu.small"
input_arity = 2
output_arity = 1

[workflows]
export = "auto"

[workflows.etl_pipeline]
version = "0.1.0"
```

Use `namu sync` to update `Cargo.toml` dependencies and `.cargo/config.toml` registries.

## Task manifest (`manifest.json`)
When building from task directories directly, each task directory should include a `manifest.json` that matches `namu_proto::TaskManifest`. When using `namu.toml`, the CLI generates this manifest for you during `namu build`.

Example:
```json
{
  "task_id": "add",
  "version": "0.1.0",
  "task_kind": "single",
  "trust": "trusted",
  "runtime": "native",
  "requires_gpu": false,
  "resource_class": "cpu.small",
  "capabilities": ["cpu"],
  "input_arity": 2,
  "output_arity": 1,
  "input_schema": { "type": "array", "items": [ {"type": "integer"}, {"type": "integer"} ] },
  "output_schema": { "type": "integer" },
  "checksum": "",
  "abi_version": "1",
  "build_toolchain": "rust-1.75.0",
  "created_at": "2026-01-18T00:00:00Z"
}
```

Rules enforced by the orchestrator:
- `trust = untrusted` requires `runtime = wasm`.
- `runtime = wasm` requires `trust = untrusted`.
- `requires_gpu = true` requires `runtime = native` and `trust != untrusted`.

`checksum` is filled in by `namu build` when packaging artifacts.

## Workflow upload payload
`namu build` copies workflow IR JSON files into `dist/workflows/`. `namu publish` uploads them as:

```json
{
  "id": "etl_pipeline",
  "version": "0.1.0",
  "ir": { "operations": [] },
  "task_versions": { "add": "0.1.0" }
}
```

Workflow files must be named `*.workflow.json`.
